---
title: Redis - Sorted Set 부동소수점 값 저장, 정렬, 조회하기
published: false
tags: redis
---

우선 제가 필요로 하는 요구사항은 아래와 같습니다.

- 자바의 `BigDecimal` 을 키로 사용하고 그에 매핑된 리스트 구조의 튜플를 저장.
  - 자바 타입으로 표현하면 `TreeMap<BigDecimal, List<String>>` 으로 될것 같습니다.
- 저장된 값들이 키값을 기준으로 정렬되어 있어야 함
- 원하는 `BigDecimal`을 사용하여 조회가능
- 원하는 `BigDecimal`의 범위로 검색가능
- 메모리 캐시를 사용하며 기본적인 영속성을 만족할 것(레디스 사용)

```yaml
###
25500:
  .12345: user1, user2
  .12346: user2, user3, user2
25505:
  .05443: user2, user1
  .233: user3
25506:
  .12345: user3, user5
###
```
위의 예시에서는 총 5개의 `BigDecimal` 키가 존재하고 각 키에 매핑된 문자열 리스트가 있습니다.
5개의 키들은 오름차순으로 정렬되어 있습니다.

만약 (25505.05443) 을 검색하면 [user2, user1] 을 얻고싶습니다.
또한 (25500.12346 - 25505.2) 으로 검색하면 [{25500.12346:user2, user3, user2}, {25505.05443:user2, user1}] 의 결과를 원합니다. 

# 1. Sorted Set
레디스의 'Sorted Set' 자료구조는 기본적으론 'Set' 자료구조와 동일하지만, 각 요소에 'score(이하 스코어)' 라는 연관값을 지정하여 정렬된 상태로 유지합니다.
기본적으로 집합 자료구조이므로 서로 다른 스코어 값을 할당하더라도 동일한 요소는 중복으로써 제거할 수 있습니다(옵션 조정필요).

```redis
127.0.0.1:6379> zadd ss 10 a
(integer) 1
127.0.0.1:6379> zadd ss 20 b
(integer) 1
127.0.0.1:6379> zrange ss 0 -1 withscores
1) "a"
2) "10"
3) "b"
4) "20"
127.0.0.1:6379>
```
기본적인 사용법은 위와 같습니다. `zadd [key] [score] [value]` 를 통해 스코어와 요소를 추가할 수 있습니다.
조회는 다른 자료구조와 비슷하게 `zrange [key] [start] [end]` 를 통해 조회할 수 있습니다.
위 예제는 마지막에 `withscores` 옵션을 추가하여 스코어도 함께 조회하도록 했습니다.

```redis
127.0.0.1:6379> zadd ss 30.3 c
(integer) 1
127.0.0.1:6379> zrange ss 0 -1 withscores
1) "a"
2) "10"
3) "b"
4) "20"
5) "c"
6) "30.300000000000001"
127.0.0.1:6379>
```

스코어 값의 타입은 double-precision 부동소수점입니다. 입력한 스코어값 30.3 이 30.300000000000001 으로 표현되었습니다.
우선은 스코어에 우리가 원하는 `BigDecimal` 값을 스코어에 저장할 수 는 없어보입니다.

# 2. lexicographical sorting 사용하기

